{% load static %}
{% load app_tags %}
<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="TG Code">
    <title>Treasury | profile</title>
    <link rel="icon" href="{% static 'assets/img/brand/favicon.png' %}" type="image/png">
    <link rel="stylesheet" href="{% static 'assets/libs/animate.css/animate.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/libs/@fortawesome/fontawesome-free/css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/libs/ionicons/css/ionicons.css' %}">
    <link rel="stylesheet" href="{% static 'assets/libs/swiper/dist/css/swiper.min.css' %}">
    <!-- Custom style -->
    <link rel="stylesheet" href="{% static 'assets/css/mega/style.css' %}" id="stylesheet">
    <link rel="stylesheet" href="{% static 'assets/css/quick-website.css' %}" id="stylesheet">
    <link rel="stylesheet" href="{% static 'assets/css/custom.css' %}" id="stylesheet">
    <link rel="stylesheet" href="{% static 'assets/libs/ip_input/jquerysctipttop.css' %}">
    {#    <link rel="stylesheet" href="{% static 'assets/libs/ip_input/bootstrap.min.css' %}">#}
    <link rel="stylesheet" href="{% static 'assets/libs/ip_input/ipInput.css' %}">


</head>

<body>

{% include 'app/basic/navbar.html' %}

<section class="page-banner" style="background: #181717; padding-bottom: 0;">
    <div class="container-fluid">
        <div class="page-title"> Your Account Information.</div>
        <div class="user-email"><span class="font-weight-bolder">Email</span>: test@gmail.com
        </div>
    </div>
</section>

<section class="container-fluid page-subtitle">

    <div style="text-align: center">
         <span class="px-2 d-md-inline-flex d-sm-block tab">
             IP Change
         </span>
        <span class="px-2 d-md-inline-flex d-sm-block tab active" style="border-left: 1px solid grey;">
             Information
         </span>
        <span class="px-2 d-md-inline-flex d-sm-block tab" style="border-left: 1px solid grey;">
             Email Change
         </span>
    </div>
</section>


<section style="min-height: Calc(100vh - 75px - 209px - 58px); margin-top: 10px">
    <div class="container d-flex justify-content-center ">
        <table class="profile-table mt-4">
            {% for key,value in result_dic.results.items %}
                <tr>
                    <td>{{ key }}</td>
                    <td>{{ value }}
                        {% if key == 'ip' %}
                            <button class="ml-10 btn btn-primary pull-right" onclick="open_change_ip_window()">change
                                Ip
                            </button>
                        {% elif key == 'last_login' %}
                            <button class="ml-10 btn btn-primary pull-right" onclick="open_change_password_window()">
                                change Password
                            </button>
                        {% endif %}
                    </td>
                </tr>

            {% endfor %}

        </table>
    </div>

</section>

<div class="modal fade" id="change-ip-modal" tabindex="-1" role="dialog" aria-labelledby="change-video-data"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title d-flex align-items-center" id="modal-title-change-username">
                    <div>
                        <div class="icon icon-sm icon-shape rounded-circle shadow mr-3">
                            <span class="fe fe-video"></span>
                        </div>
                    </div>
                    <div>
                        <h6 class="mb-0">Change Ip</h6>
                    </div>

                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row px-5">
                    <span>New Ip</span>
                    <div id="ip" class="ml-3"></div>
                </div>
                <div class="mt-3"></div>
                <button class="btn btn-primary " style="float: right; " onclick="change_ip()">Change</button>
                <div style="clear: both"></div>
                <div id="ip-msg"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="change-password-modal" tabindex="-1" role="dialog" aria-labelledby="change-video-data"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title d-flex align-items-center" id="modal-title-change-username">
                    <div>
                        <div class="icon icon-sm icon-shape rounded-circle shadow mr-3">
                            <span class="fe fe-video"></span>
                        </div>
                    </div>
                    <div>
                        <h6 class="mb-0">Change Password</h6>
                    </div>

                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <label class="form-control-label mt-4" for="input-password">New password</label>
                <input class="form-control" id="input-password" name="password" placeholder="Put Email" type="email"
                       value="new.account@treasuryquants.com">
                <label class="form-control-label" for="input-password">Confirm password</label>
                <input class="form-control" id="input-password-confirm" name="password_confirm" placeholder="Put Email"
                       type="email" value="new.account@treasuryquants.com">

                <div class="mt-3"></div>
                <button class="btn btn-primary " style="float: right; " onclick="change_password()">Change</button>
                <div style="clear: both"></div>
                <div id="password-msg"></div>
            </div>
        </div>
    </div>
</div>

{% include "app/basic/footer.html" %}

<!-- Core JS  -->
<script src="{% static 'assets/js/jquery.js' %}"></script>
<script src="{% static 'assets/js/jquery.migrate.js' %}"></script>
{#<script src="{% static 'assets/libs/ip_input/jquery-3.2.1.slim.min.js' %}"></script>#}

{#  <script src="{% static 'assets/libs/jquery/dist/jquery.min.js' %}"></script>#}

<script src="{% static 'assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'assets/libs/svg-injector/dist/svg-injector.min.js' %}"></script>
<script src="{% static 'assets/libs/feather-icons/dist/feather.min.js' %}"></script>
<!-- Optional JS -->
<script src="{% static 'assets/libs/in-view/dist/in-view.min.js' %}"></script>
<script src="{% static 'assets/libs/sticky-kit/dist/sticky-kit.min.js' %}"></script>
<script src="{% static 'assets/libs/imagesloaded/imagesloaded.pkgd.min.js' %}"></script>
<!-- Page JS -->
<script src="{% static 'assets/libs/bootstrap-notify/bootstrap-notify.min.js' %}"></script>
<script src="{% static 'assets/libs/autosize/dist/autosize.min.js' %}"></script>
<script src="{% static 'assets/libs/bootstrap-tagsinput/dist/bootstrap-tagsinput.min.js' %}"></script>
<script src="{% static 'assets/libs/swiper/dist/js/swiper.min.js' %}"></script>
<script src="{% static 'assets/libs/owl.carousel/owl.carousel.js' %}"></script>
<script src="{% static 'assets/libs/easescroll/jquery.easeScroll.js' %}"></script>
<!-- Quick JS -->

{#<script src="{% static 'assets/js/e-magz.js' %}"></script>#}
<script src="{% static 'assets/js/quick-website.js' %}"></script>
<script src="{% static 'assets/libs/ip_input/ipInput.js' %}"></script>


<!-- Feather Icons -->
<script>
    feather.replace({
        'width': '1em',
        'height': '1em'
    });

    var ipInput = $('#ip').ipInput();

    function change_ip() {
        let ip = ipInput.getIp();
        var token = '{{csrf_token}}';
        $.ajax({
            headers: {
                "X-CSRFToken": token
            },
            type: 'post',
            url: "{% url 'account_cycle:account_api' %}",
            data: JSON.stringify({
                'function_name': 'account_ip_change',
                'arguments': {
                    'user_email': '{{ user_email }}',
                    'user_password': '{{ password }}',
                    'new_ip': ip,
                },
                'source_caller': document.location.href,
            }),
            success: function (data) {

                if (data.error) {
                    $('#ip-msg').text(data['error']);
                } else {
                    $('#ip-msg').text(data['account_ip_change']);
                    document.location.href = '{% url "account_cycle:profile" %}';
                }
            }
        });
    }

    function open_change_ip_window() {
        $('#change-ip-modal').modal('show');
    }

    function open_change_password_window() {
        $('#change-password-modal').modal('show');
    }


    function change_password(){
        let password = $('#input-password').val();
        let confirm_password = $('#input-password-confirm').val();
        msg_text = ''
        if(password.length < 10){
            msg_text = 'Password must be at least 10 characters.';
        }
        if(password !== confirm_password){
            msg_text += 'Password not matched.';
        }
        if(msg_text){
            $('#password-msg').text(msg_text);
            return;
        }

        let token = '{{csrf_token}}';
        $.ajax({
            headers: {
                "X-CSRFToken": token
            },
            type: 'post',
            url: "{% url 'account_cycle:account_api' %}",
            data:JSON.stringify({
                'function_name': 'account_password_change',
                'arguments': {
                    'user_email': '{{ user_email }}',
                    'user_password': '{{ password }}',
                    'new_password': password,
                 },
                'source_caller': document.location.href,
            }),
            success: function (data){
               if (data.error){
                      $('#password-msg').text(data['error']);
               }
               else{
                      $('#password-msg').html(`Password reseted successfully. <a href="{% url 'app:logout' %}">Please login using new password. </a>`)

               }
            }
        });

    }

</script>
</body>

</html>